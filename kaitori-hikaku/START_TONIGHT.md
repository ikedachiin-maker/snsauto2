# 🌙 今夜の実行手順

## ⏰ 実行タイミング

**推奨**: 寝る直前（23:00〜24:00頃）
**所要時間**: 1.5〜2時間
**完了予定**: 深夜1:00〜2:00頃

---

## 🚀 ステップ1: 実行開始（寝る前）

### エクスプローラーから実行（最も簡単）

1. エクスプローラーで以下のフォルダを開く
   ```
   C:\Users\ysfm0664\OneDrive\Desktop\snsauto\kaitori-hikaku\scripts
   ```

2. **`run-overnight.bat`** をダブルクリック

3. 黒い画面が表示され、処理が開始されます
   ```
   ========================================
     買取比較くん - 定価一括取得（夜間実行）
   ========================================

   開始時刻: 2026-02-23 23:30:45
   対象: 約1,682商品（定価なし）
   予想所要時間: 1.5〜2時間

   [1/1682] PlayStation 5 Slim...
   ```

4. **このウィンドウは閉じないでください**
   - 最小化してOK
   - PCをスリープさせないように設定

---

### または、コマンドラインから実行

```bash
cd C:\Users\ysfm0664\OneDrive\Desktop\snsauto\kaitori-hikaku
scripts\run-overnight.bat
```

---

## 💤 ステップ2: 就寝

- PCの電源設定を確認
  - 「スリープしない」に設定
  - または「電源に接続時はスリープしない」
- ネットワーク接続を確認
- そのまま就寝 😴

---

## ☀️ ステップ3: 朝起きたら確認

### 3-1. 実行完了を確認

バッチファイルのウィンドウを確認：

```
========================================
  実行完了: 2026-02-24 01:45:23
========================================

結果を確認してください:
  1. logs\fetch-prices-20260224.log
  2. data\json\retail_prices_found.json

次のステップ:
  npm run merge-prices
```

**完了していたら**、何かキーを押してウィンドウを閉じる

### 3-2. 結果を確認

#### ログファイルを開く
```
kaitori-hikaku\logs\fetch-prices-YYYYMMDD.log
```

最後の方にサマリーが表示されます：
```
=== Summary ===
New prices found: 1124
Total prices saved: 1124
Errors: 558
Output: data\json\retail_prices_found.json
```

#### 取得データを確認
```
kaitori-hikaku\data\json\retail_prices_found.json
```
このファイルが存在していればOK

---

## 🔧 ステップ4: データをマージ

コマンドプロンプトを開いて実行：

```bash
cd C:\Users\ysfm0664\OneDrive\Desktop\snsauto\kaitori-hikaku
npm run merge-prices
```

実行結果例：
```
========================================
  定価データのマージ
========================================

📦 商品数: 1706
💰 取得した定価: 1124件

💾 バックアップ作成: products.backup.json

✓ [1] PlayStation 5 Slim CFI-2000A01
   定価: ¥66,980 (ソース: google)
   差額: ¥20,980, 還元率: 68.7%

...

========================================
✅ マージ完了
   更新: 1124商品
   定価あり: 1148/1706商品
   定価なし: 558商品
========================================
```

---

## 🎉 ステップ5: 確認

開発サーバーを起動：

```bash
npm run dev
```

ブラウザで開く：
```
http://localhost:3000
```

### 確認ポイント

✅ 商品カードに「定価」と「差額」が表示される
✅ 還元率バッジが表示される（色分け）
✅ 商品詳細ページで差額グラフが見える

---

## ⚠️ トラブルシューティング

### 問題1: 実行中にウィンドウが消えた

**原因**: PCがスリープした、またはエラー発生

**対処**:
1. ログファイルを確認
   ```
   kaitori-hikaku\logs\fetch-prices-YYYYMMDD.log
   ```
2. `retail_prices_found.json` が存在するか確認
3. 存在すれば、そこまでのデータは保存済み
4. 再実行すると、続きから処理されます

### 問題2: 途中で大量のエラー

**症状**:
```
[150/1682] ...
  Google search error: HTTP Error 429
  Kakaku search error: ...
  Amazon search error: ...
```

**原因**: IPアドレスがブロックされた

**対処**:
1. Ctrl+C で一時停止
2. `retail_prices_found.json` を確認（150件は保存済み）
3. 翌日または数時間後に再実行
4. または、遅延時間を増やす（下記参照）

### 問題3: もっとゆっくり実行したい

`fetch-retail-prices-bulk.py` の19行目を編集：

```python
DELAY_BETWEEN_REQUESTS = 5.0  # 2.0 → 5.0秒に変更
```

所要時間: 2時間 → 3.5時間

---

## 📊 期待される結果

### 取得成功の目安

- **良好**: 800件以上取得（約50%）
- **普通**: 500〜800件（約30〜50%）
- **要調整**: 500件未満（遅延時間を増やす）

### 取得ソースの内訳（予想）

- Google: 30〜40%
- 価格.com: 20〜30%
- Amazon: 10〜20%
- 推定: 残り全部

---

## ✅ 完了後のチェックリスト

- [ ] ログファイル確認
- [ ] `retail_prices_found.json` 存在確認
- [ ] `npm run merge-prices` 実行
- [ ] `npm run dev` で動作確認
- [ ] 定価・差額・還元率が正しく表示されるか確認

---

## 🎯 次回以降の改善

今回の結果を見て、必要に応じて：

1. **遅延時間の調整** - ブロックされた場合
2. **分割実行** - 1日200件ずつ
3. **手動補正** - 推定値の精度チェック

---

## 📞 何かあったら

1. ログファイルを確認
2. `retail_prices_found.json` があれば、そこまでは成功
3. バックアップ（`products.backup.json`）から復元可能

**楽しい夜間実行を！** 🌙✨

明日の朝、素晴らしい結果が待っています 🎉
