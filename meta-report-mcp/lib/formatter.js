// â”€â”€ Report Formatters (Markdown, CSV, JSON) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€ Format Currency â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function formatCurrency(value, currency = "JPY") {
  if (value == null) return "-";
  const num = parseFloat(value);
  if (currency === "JPY") {
    return `Â¥${Math.round(num).toLocaleString()}`;
  }
  return `$${num.toFixed(2)}`;
}

function formatNumber(value) {
  if (value == null) return "-";
  return parseInt(value).toLocaleString();
}

function formatPercent(value) {
  if (value == null) return "-";
  return `${parseFloat(value).toFixed(2)}%`;
}

function formatDecimal(value, places = 2) {
  if (value == null) return "-";
  return parseFloat(value).toFixed(places);
}

// â”€â”€ Markdown Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function markdownTable(headers, rows) {
  const separator = headers.map(() => "---").join(" | ");
  const headerRow = headers.join(" | ");
  const dataRows = rows.map((r) => r.join(" | ")).join("\n");
  return `${headerRow}\n${separator}\n${dataRows}`;
}

// â”€â”€ Format as Markdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function formatAsMarkdown(report) {
  let md = `# ${report.title || "Meta Ads Report"}\n\n`;

  // Metadata
  if (report.date_range) {
    md += `**æœŸé–“**: ${report.date_range.since} ã€œ ${report.date_range.until}\n\n`;
  }
  if (report.generated_at) {
    md += `**ç”Ÿæˆæ—¥æ™‚**: ${new Date(report.generated_at).toLocaleString("ja-JP")}\n\n`;
  }

  md += "---\n\n";

  // Summary
  if (report.summary) {
    md += "## ğŸ“Š ã‚µãƒãƒªãƒ¼\n\n";
    const s = report.summary;
    md += `- **ç·æ¶ˆè²»é¡**: ${formatCurrency(s.total_spend)}\n`;
    md += `- **ç·ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³**: ${formatNumber(s.total_impressions)}\n`;
    md += `- **ç·ã‚¯ãƒªãƒƒã‚¯**: ${formatNumber(s.total_clicks)}\n`;
    md += `- **ç·ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ${formatNumber(s.total_conversions)}\n`;
    md += `- **å¹³å‡CTR**: ${formatPercent(s.avg_ctr)}\n`;
    md += `- **å¹³å‡CPC**: ${formatCurrency(s.avg_cpc)}\n`;
    md += `- **å¹³å‡CPA**: ${formatCurrency(s.avg_cpa)}\n`;
    md += `- **å¹³å‡ãƒ•ãƒªã‚¯ã‚¨ãƒ³ã‚·ãƒ¼**: ${formatDecimal(s.avg_frequency)}\n\n`;
  }

  // Top performers
  if (report.top_performers) {
    md += "## ğŸ† ãƒˆãƒƒãƒ—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ¼\n\n";
    md += `**åŸºæº–**: ${report.top_performers.metric_label}\n\n`;
    const headers = ["é †ä½", "åå‰", report.top_performers.metric_label, "æ¶ˆè²»é¡", "ã‚¯ãƒªãƒƒã‚¯"];
    const rows = report.top_performers.top.slice(0, 10).map((p, i) => [
      i + 1,
      p.name,
      formatDecimal(p.metric_value),
      formatCurrency(p.spend),
      formatNumber(p.clicks),
    ]);
    md += markdownTable(headers, rows) + "\n\n";
  }

  // Trends
  if (report.trends) {
    md += "## ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ\n\n";
    md += `**ãƒˆãƒ¬ãƒ³ãƒ‰**: ${report.trends.trend === "improving" ? "ğŸ“ˆ æ”¹å–„ä¸­" : report.trends.trend === "declining" ? "ğŸ“‰ ä½ä¸‹ä¸­" : "â†’ å®‰å®š"}\n\n`;
    if (report.trends.changes) {
      md += `- æ¶ˆè²»é¡å¤‰åŒ–: ${report.trends.changes.spend_change_percent > 0 ? "+" : ""}${report.trends.changes.spend_change_percent}%\n`;
      md += `- ã‚¯ãƒªãƒƒã‚¯å¤‰åŒ–: ${report.trends.changes.click_change_percent > 0 ? "+" : ""}${report.trends.changes.click_change_percent}%\n`;
      md += `- CVå¤‰åŒ–: ${report.trends.changes.conversion_change_percent > 0 ? "+" : ""}${report.trends.changes.conversion_change_percent}%\n\n`;
    }
  }

  // Breakdown
  if (report.breakdown) {
    md += `## ğŸ“Š ${report.breakdown.breakdown_type} åˆ¥åˆ†æ\n\n`;
    const headers = ["ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ", "æ¶ˆè²»é¡", "ã‚·ã‚§ã‚¢", "CTR", "CPA"];
    const rows = report.breakdown.segments.slice(0, 10).map((seg) => [
      seg.segment,
      formatCurrency(seg.spend),
      formatPercent(seg.spend_percent),
      formatPercent(seg.ctr),
      formatCurrency(seg.cpa),
    ]);
    md += markdownTable(headers, rows) + "\n\n";
  }

  // Recommendations
  if (report.recommendations && report.recommendations.length > 0) {
    md += "## ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³\n\n";
    report.recommendations.forEach((rec, i) => {
      md += `${i + 1}. **${rec.title}**: ${rec.description}\n`;
    });
    md += "\n";
  }

  md += "---\n\n";
  md += "_Generated by Meta Report MCP Server_\n";

  return md;
}

// â”€â”€ Format as CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function formatAsCSV(data, columns) {
  if (!data || data.length === 0) return "";

  // Auto-detect columns if not provided
  if (!columns) {
    columns = Object.keys(data[0]);
  }

  // Header
  let csv = columns.join(",") + "\n";

  // Rows
  for (const row of data) {
    const values = columns.map((col) => {
      let val = row[col];
      if (val == null) return "";
      if (typeof val === "object") val = JSON.stringify(val);
      val = String(val).replace(/"/g, '""'); // Escape quotes
      return `"${val}"`;
    });
    csv += values.join(",") + "\n";
  }

  return csv;
}

// â”€â”€ Format as Plain Text Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function formatAsTextTable(data, columns) {
  if (!data || data.length === 0) return "No data";

  if (!columns) {
    columns = Object.keys(data[0]);
  }

  // Calculate column widths
  const widths = {};
  for (const col of columns) {
    widths[col] = Math.max(
      col.length,
      ...data.map((row) => String(row[col] || "").length)
    );
  }

  // Header
  let table = columns.map((col) => col.padEnd(widths[col])).join(" | ") + "\n";
  table += columns.map((col) => "-".repeat(widths[col])).join("-+-") + "\n";

  // Rows
  for (const row of data) {
    table += columns.map((col) => String(row[col] || "").padEnd(widths[col])).join(" | ") + "\n";
  }

  return table;
}

// â”€â”€ Generate Recommendations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function generateRecommendations(summary, topPerformers, trends) {
  const recommendations = [];

  // High CPA warning
  if (summary?.avg_cpa > 5000) {
    recommendations.push({
      priority: "high",
      title: "é«˜CPAæ”¹å–„",
      description: `å¹³å‡CPA Â¥${Math.round(summary.avg_cpa)} ã¯é«˜ã‚ã§ã™ã€‚ä½ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åºƒå‘Šã‚»ãƒƒãƒˆã®åœæ­¢ã¾ãŸã¯ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°è¦‹ç›´ã—ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚`,
    });
  }

  // Low CTR warning
  if (summary?.avg_ctr < 0.5) {
    recommendations.push({
      priority: "medium",
      title: "CTRæ”¹å–„",
      description: `å¹³å‡CTR ${summary.avg_ctr.toFixed(2)}% ã¯ä½ã‚ã§ã™ã€‚ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã®åˆ·æ–°ã‚„ã‚³ãƒ”ãƒ¼ã®è¦‹ç›´ã—ã‚’æ¨å¥¨ã—ã¾ã™ã€‚`,
    });
  }

  // High frequency
  if (summary?.avg_frequency > 3) {
    recommendations.push({
      priority: "medium",
      title: "ãƒ•ãƒªã‚¯ã‚¨ãƒ³ã‚·ãƒ¼ç®¡ç†",
      description: `å¹³å‡ãƒ•ãƒªã‚¯ã‚¨ãƒ³ã‚·ãƒ¼ ${summary.avg_frequency.toFixed(1)} ã¯é«˜ã‚ã§ã™ã€‚ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹æ‹¡å¤§ã¾ãŸã¯ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–æ›´æ–°ã§åºƒå‘Šç–²å¼Šã‚’é˜²ãã¾ã—ã‚‡ã†ã€‚`,
    });
  }

  // Declining trend
  if (trends?.trend === "declining") {
    recommendations.push({
      priority: "high",
      title: "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹",
      description: "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä½ä¸‹å‚¾å‘ã§ã™ã€‚äºˆç®—é…åˆ†ã®è¦‹ç›´ã—ã€A/Bãƒ†ã‚¹ãƒˆå®Ÿæ–½ã€ã¾ãŸã¯ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å†æ§‹ç¯‰ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚",
    });
  }

  // Scale top performers
  if (topPerformers?.top && topPerformers.top.length > 0) {
    const best = topPerformers.top[0];
    recommendations.push({
      priority: "medium",
      title: "å‹è€…ã‚¹ã‚±ãƒ¼ãƒ«",
      description: `ã€Œ${best.name}ã€ãŒæœ€é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã§ã™ã€‚äºˆç®—å¢—é¡ã§ã•ã‚‰ãªã‚‹æˆæœã‚’ç‹™ã„ã¾ã—ã‚‡ã†ã€‚`,
    });
  }

  return recommendations;
}
